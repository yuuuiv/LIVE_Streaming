<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’­æ”¾å™¨ - NeoFantasy Live</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: 'class',
    }
    </script>
    
    <!-- ArtPlayer CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.css">
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* é˜²æ­¢å…¨å±æ—¶å‡ºç°æ»šåŠ¨æ¡ */
        #player-container:fullscreen,
        #player-container:-webkit-full-screen,
        #player-container:-moz-full-screen,
        #player-container:-ms-fullscreen {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #player-container {
            width: 100%;
            height: 100%;
        }
        
        #error-container {
            display: none;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 2rem;
            z-index: 9998;
        }
        
        /* å…¨å±æ¨¡å¼ä¸‹çš„é”™è¯¯æç¤ºæ ·å¼ */
        #player-container:fullscreen #error-container,
        #player-container:-webkit-full-screen #error-container,
        #player-container:-moz-full-screen #error-container,
        #player-container:-ms-fullscreen #error-container {
            background: #000;
            position: fixed;
            inset: 0;
        }
        
        #loading-container {
            display: flex;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: rgb(139, 92, 246);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .error-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .error-message {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
        }
        
        .back-button {
            padding: 0.75rem 2rem;
            background: rgb(139, 92, 246);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .back-button:hover {
            background: rgb(124, 58, 237);
        }

        .back-button-red {
            background: #ef4444 !important;
        }
        .back-button-red:hover {
            background: #dc2626 !important;
        }

        /* è¢«è¸¢ä¸‹çº¿é®ç½© */
        #kick-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.85);
            color: #f87171;
            z-index: 50;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 2rem;            pointer-events: none;
        }
        
        #kick-overlay.active {
            pointer-events: auto;        }
        #kick-overlay h2 {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
        }
        #kick-overlay p {
            color: #fecaca;
            margin-bottom: 1.5rem;
        }

        /* ArtPlayer è¿›åº¦æ¡ä¿®å¤Šï¼Œé˜²æ­¢è¢«æˆªæ–­ */
        .art-video-player {
            width: 100% !important;
            height: 100% !important;
        }
        
        .art-bottom {
            padding-bottom: 0 !important;
        }
        
        .art-controls {
            bottom: 0 !important;
        }
        
        /* å¼ºåˆ¶è®¾ç½®æ§åˆ¶æ¡ä½ç½®ï¼Œç¡®ä¿å®Œå…¨å¯è§ */
        .art-control-bar {
            bottom: 2px !important;
        }
        
        /* ç¡®ä¿éŸ³é‡æ§ä»¶æ˜¾ç¤º */
        .art-control-volume {
            display: flex !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    
    <!-- Loading Container -->
    <div id="loading-container">
        <div class="spinner"></div>
        <p class="mt-4 text-lg">æ­£åœ¨åŠ è½½è§†é¢‘...</p>
    </div>
    
    <!-- Error Container -->
    <div id="error-container">
        <div class="error-icon">âŒ</div>
        <div class="error-title" id="error-title">åŠ è½½å¤±è´¥</div>
        <div class="error-message" id="error-message">æœªçŸ¥é”™è¯¯</div>
        <button class="back-button" onclick="goBack()">è¿”å›é¦–é¡µ</button>
    </div>
    
    <!-- Player Container -->
    <div id="player-container"></div>

    <!-- Kick Overlay -->
    <div id="kick-overlay">
        <h2>âš  æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•</h2>
        <p>å½“å‰æ’­æ”¾å·²åœæ­¢ï¼Œè¯·é‡æ–°ç™»å½•åç»§ç»­è§‚çœ‹ã€‚</p>
        <button class="back-button back-button-red" type="button" onclick="goBack()">è¿”å›é¦–é¡µ</button>
    </div>
    
    <script>
        // è‡ªåŠ¨æ£€æµ‹ API åœ°å€ - å¼€å‘ç¯å¢ƒä½¿ç”¨ localhostï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç”Ÿäº§ API
        const API_BASE_URL = 'https://api.neofantasy.online';
        let artPlayer = null;
        let heartbeatTimer = null;
        let sessionId = null;
        let username = null;
        
        // æ›´æ–°æ§åˆ¶æ ä¸Šçš„éŸ³é‡æ˜¾ç¤º
        function updateVolumeDisplay() {
            if (!artPlayer) return;
            
            const volumeControl = document.querySelector('.art-control-volume-display');
            if (!volumeControl) return;
            
            const volume = artPlayer.volume;
            const muted = artPlayer.muted;
            
            if (muted) {
                volumeControl.textContent = 'é™éŸ³';
            } else {
                const percent = Math.round(volume * 100);
                volumeControl.textContent = percent + '%';
            }
        }
        
        // åˆå§‹åŒ–ä¸»é¢˜ - ä» localStorage è¯»å–
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('bg-gray-900');
                document.body.classList.add('bg-gray-50', 'text-gray-900');
            }
        }
        
        // ä» URL è·å–å‚æ•°
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                show_id: params.get('show_id'),
                user_token: params.get('user_token')
            };
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(title, message, icon = 'âŒ') {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('player-container').style.display = 'none';
            
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'flex';
            
            document.querySelector('.error-icon').textContent = icon;
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
        }
        
        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            document.getElementById('loading-container').style.display = 'none';
        }
        
        // è¿”å›é¦–é¡µ
        function goBack() {
            window.close();
            // å¦‚æœ window.close() å¤±è´¥ï¼ˆéè„šæœ¬æ‰“å¼€çš„çª—å£ï¼‰ï¼Œåˆ™è·³è½¬å›é¦–é¡µ
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 100);
        }
        
        // åˆå§‹åŒ–æ’­æ”¾å™¨
        function initPlayer(streamUrl, showId) {
            hideLoading();
            document.getElementById('player-container').style.display = 'block';
            
            artPlayer = new Artplayer({
                container: '#player-container',
                url: streamUrl,
                type: 'm3u8',
                customType: {
                    m3u8: function(video, url) {
                        if (Hls.isSupported()) {
                            const hls = new Hls({
                                enableWorker: true,
                                lowLatencyMode: true,
                            });
                            hls.loadSource(url);
                            hls.attachMedia(video);
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        }
                    }
                },
                // åŸºæœ¬è®¾ç½®
                autoplay: true,
                autoSize: false,
                autoMini: false,
                loop: false,
                volume: 0.7,
                muted: false,
                
                // æ§ä»¶è®¾ç½®
                flip: true,
                playbackRate: true,
                aspectRatio: true,
                screenshot: true,
                setting: true,
                hotkey: true,  // å¼€å¯å†…ç½®å¿«æ·é”®
                pip: true,
                mutex: true,
                fullscreen: true,
                fullscreenWeb: true,
                
                // éŸ³é‡æ§ä»¶
                volume: 0.7,
                
                // å­—å¹•è®¾ç½®
                subtitle: {
                    url: '',
                    style: {
                        color: '#fff',
                        fontSize: '20px',
                    },
                },
                
                // æ’­æ”¾è®¾ç½®
                moreVideoAttr: {
                    preload: 'auto',
                    'webkit-playsinline': true,
                    'playsinline': true,
                },
                
                // è®¾ç½®é€‰é¡¹
                settings: [
                    {
                        html: 'æ’­æ”¾é€Ÿåº¦',
                        selector: [
                            { html: '2.0x', value: 2.0 },
                            { html: '1.5x', value: 1.5 },
                            { html: '1.25x', value: 1.25 },
                            { html: 'æ­£å¸¸', value: 1.0, default: true },
                            { html: '0.75x', value: 0.75 },
                            { html: '0.5x', value: 0.5 },
                        ],
                        onSelect: function (item) {
                            artPlayer.playbackRate = item.value;
                            return item.html;
                        },
                    },
                ],
                
                // ç§»åŠ¨ç«¯ä¼˜åŒ–
                autoOrientation: true,
                lock: true,  // ç§»åŠ¨ç«¯é”å±åŠŸèƒ½
            });

            artPlayer.on('ready', () => {
                console.log('Player is ready');
                
                // åˆå§‹åŒ–éŸ³é‡æ˜¾ç¤º
                updateVolumeDisplay();
                
                // ç›‘å¬éŸ³é‡å˜åŒ–ï¼ˆåŒ…æ‹¬åŸç”Ÿæ§åˆ¶æ çš„æ“ä½œï¼‰
                artPlayer.on('volumechange', () => {
                    updateVolumeDisplay();
                });
                
                // ç›‘å¬å…¨å±å˜åŒ–ï¼Œç¡®ä¿è¿›åº¦æ¡åæ ‡åŒæ­¥
                artPlayer.on('fullscreen', (isFullscreen) => {
                    console.log('å…¨å±çŠ¶æ€å˜åŒ–:', isFullscreen);
                    setTimeout(() => {
                        artPlayer.resize();
                    }, 100);
                });
                
                // ç›‘å¬ç½‘é¡µå…¨å±å˜åŒ–
                artPlayer.on('fullscreenWeb', (isFullscreenWeb) => {
                    console.log('ç½‘é¡µå…¨å±çŠ¶æ€å˜åŒ–:', isFullscreenWeb);
                    setTimeout(() => {
                        artPlayer.resize();
                    }, 100);
                });
            });
            
            artPlayer.on('error', (err) => {
                console.error('Player error:', err);
                showError(
                    'æ’­æ”¾å¤±è´¥',
                    'è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•',
                    'âš ï¸'
                );
            });
        }

        function handleKicked(message = 'æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚') {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
            }
            if (artPlayer) {
                artPlayer.destroy();
                artPlayer = null;
            }
            const overlay = document.getElementById('kick-overlay');
            overlay.style.display = 'flex';
            overlay.classList.add('active');
            document.querySelector('#kick-overlay p').textContent = message;
        }

        async function startHeartbeat() {
            if (!username || !sessionId) return;
            heartbeatTimer = setInterval(async () => {
                try {
                    const resp = await fetch(`${API_BASE_URL}/api/heartbeat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, session_id: sessionId })
                    });

                    if (resp.status === 403) {
                        handleKicked('æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚');
                        return;
                    }

                    if (!resp.ok) {
                        handleKicked('æ ¡éªŒå¤±è´¥ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚');
                        return;
                    }
                } catch (err) {
                    console.error('heartbeat error:', err);
                    handleKicked('é‰´æƒå¼‚å¸¸ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚');
                }
            }, 25000); // 25s
        }
        
        // è·å–è§†é¢‘æµå¹¶é‰´æƒ
        async function loadStream() {
            const { show_id, user_token } = getUrlParams();
            username = user_token;
            
            // å‚æ•°æ ¡éªŒ - åªæ£€æŸ¥ show_idï¼Œå…è´¹èŠ‚ç›®å…è®¸æ—  user_token
            if (!show_id) {
                showError(
                    'å‚æ•°é”™è¯¯',
                    'ç¼ºå°‘èŠ‚ç›® IDï¼Œè¯·ä»é¦–é¡µé‡æ–°è¿›å…¥',
                    'âš ï¸'
                );
                return;
            }
            
            try {
                console.log('Requesting stream for show:', show_id);
                // æ„é€ è¯·æ±‚ URL - å¦‚æœæ²¡æœ‰ user_token å°±ä¸ä¼ 
                const url = user_token 
                    ? `${API_BASE_URL}/get-stream?show_id=${show_id}&user_token=${user_token}`
                    : `${API_BASE_URL}/get-stream?show_id=${show_id}`;
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Stream URL received:', data.url);
                    sessionId = data.session_id;
                    
                    // åˆå§‹åŒ–æ’­æ”¾å™¨
                    initPlayer(data.url, show_id);
                    
                    // åªæœ‰å½“æœ‰ user_token å’Œ session_id æ—¶æ‰å¯åŠ¨å¿ƒè·³æ£€æµ‹
                    if (username && sessionId) {
                        startHeartbeat();
                    } else {
                        console.log('å…è´¹èŠ‚ç›®ï¼Œè·³è¿‡å¿ƒè·³æ£€æµ‹');
                    }
                } else {
                    // æ ¹æ®ä¸åŒçš„é”™è¯¯ç æ˜¾ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯
                    let errorTitle = 'åŠ è½½å¤±è´¥';
                    let errorMessage = 'æœªçŸ¥é”™è¯¯';
                    let errorIcon = 'âŒ';
                    
                    switch (response.status) {
                        case 403:
                            errorTitle = 'æƒé™ä¸è¶³';
                            errorMessage = 'æ‚¨å°šæœªè´­ä¹°æ­¤èŠ‚ç›®ï¼Œæˆ–æ‚¨çš„è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ';
                            errorIcon = 'ğŸ”’';
                            break;
                        case 404:
                            errorTitle = 'è§†é¢‘æœªæ‰¾åˆ°';
                            errorMessage = 'è¯¥è§†é¢‘æš‚æœªä¸Šçº¿æˆ–å·²ä¸‹æ¶ï¼Œè¯·ç¨åé‡è¯•';
                            errorIcon = 'ğŸ”';
                            break;
                        case 400:
                            errorTitle = 'å‚æ•°é”™è¯¯';
                            errorMessage = 'è¯·æ±‚å‚æ•°æœ‰è¯¯ï¼Œè¯·è¿”å›é¦–é¡µé‡æ–°è¿›å…¥';
                            errorIcon = 'âš ï¸';
                            break;
                        case 500:
                        case 502:
                        case 503:
                            errorTitle = 'æœåŠ¡å™¨é”™è¯¯';
                            errorMessage = 'æœåŠ¡å™¨æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åé‡è¯•';
                            errorIcon = 'ğŸ”§';
                            break;
                        default:
                            errorTitle = 'åŠ è½½å¤±è´¥';
                            errorMessage = `è¯·æ±‚å¤±è´¥ï¼Œé”™è¯¯ç : ${response.status}`;
                            errorIcon = 'âŒ';
                    }
                    
                    showError(errorTitle, errorMessage, errorIcon);
                }
            } catch (error) {
                console.error('Network error:', error);
                showError(
                    'ç½‘ç»œé”™è¯¯',
                    'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥',
                    'ğŸŒ'
                );
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadStream();
        });
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ŒåŒæ­¥æ’­æ”¾å™¨å°ºå¯¸
        window.addEventListener('resize', () => {
            if (artPlayer) {
                artPlayer.resize();
            }
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (!artPlayer) return;
            
            // é˜²æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
            const preventScrollKeys = ['Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            if (preventScrollKeys.includes(e.code)) {
                e.preventDefault();
            }
            
            // ç©ºæ ¼é”®ï¼šåˆ‡æ¢æ’­æ”¾/æš‚åœ
            if (e.code === 'Space') {
                artPlayer.toggle();
            } 
            // Mé”®ï¼šåˆ‡æ¢é™éŸ³
            else if (e.code === 'KeyM') {
                e.preventDefault();
                artPlayer.muted = !artPlayer.muted;
                // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼ˆvolumechange äº‹ä»¶ä¹Ÿä¼šè§¦å‘ï¼Œä½†è¿™é‡Œç¡®ä¿å³æ—¶åé¦ˆï¼‰
                updateVolumeDisplay();
                console.log('é™éŸ³çŠ¶æ€:', artPlayer.muted ? 'å·²é™éŸ³' : 'å·²å–æ¶ˆé™éŸ³');
            } 
            // å·¦ç®­å¤´ï¼šåé€€5ç§’
            else if (e.code === 'ArrowLeft') {
                const newTime = Math.max(0, artPlayer.currentTime - 5);
                artPlayer.seek = newTime;
                console.log('åé†€5ç§’è‡³:', Math.floor(newTime) + 's');
            } 
            // å³ç®­å¤´ï¼šå‰è¿›5ç§’
            else if (e.code === 'ArrowRight') {
                const newTime = Math.min(artPlayer.duration, artPlayer.currentTime + 5);
                artPlayer.seek = newTime;
                console.log('å‰è¿›5ç§’è‡³:', Math.floor(newTime) + 's');
            } 
            // ä¸Šç®­å¤´ï¼šå¢åŠ éŸ³é‡5%
            else if (e.code === 'ArrowUp') {
                const newVolume = Math.min(1, artPlayer.volume + 0.05);
                artPlayer.volume = newVolume;
                // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼ˆvolumechange äº‹ä»¶ä¹Ÿä¼šè§¦å‘ï¼Œä½†è¿™é‡Œç¡®ä¿å³æ—¶åé¦ˆï¼‰
                updateVolumeDisplay();
                console.log('éŸ³é‡:', Math.round(newVolume * 100) + '%');
            } 
            // ä¸‹ç®­å¤´ï¼šå‡å°‘éŸ³é‡5%
            else if (e.code === 'ArrowDown') {
                const newVolume = Math.max(0, artPlayer.volume - 0.05);
                artPlayer.volume = newVolume;
                // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼ˆvolumechange äº‹ä»¶ä¹Ÿä¼šè§¦å‘ï¼Œä½†è¿™é‡Œç¡®ä¿å³æ—¶åé¦ˆï¼‰
                updateVolumeDisplay();
                console.log('éŸ³é‡:', Math.round(newVolume * 100) + '%');
            } 
            // Fé”®ï¼šåˆ‡æ¢å…¨å±
            else if (e.code === 'KeyF') {
                e.preventDefault();
                artPlayer.fullscreen = !artPlayer.fullscreen;
            } 
            // Enteré”®ï¼ˆä¸»é”®ç›˜å’Œæ•°å­—é”®ç›˜ï¼‰ï¼šåˆ‡æ¢å…¨å±
            else if (e.code === 'Enter' || e.code === 'NumpadEnter') {
                e.preventDefault();
                artPlayer.fullscreen = !artPlayer.fullscreen;
                console.log('å…¨å±çŠ¶æ€:', artPlayer.fullscreen ? 'å…¨å±' : 'é€€å‡ºå…¨å±');
            }
            // Escapeé”®ï¼šé€€å‡ºå…¨å±
            else if (e.code === 'Escape' && artPlayer.fullscreen) {
                e.preventDefault();
                artPlayer.fullscreen = false;
            }
        }, { passive: false });
        
        // é¡µé¢å…³é—­å‰æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
            }
            if (artPlayer) {
                artPlayer.destroy();
            }
        });
    </script>
</body>
</html>
