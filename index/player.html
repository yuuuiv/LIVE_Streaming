<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êí≠ÊîæÂô® - NeoFantasy Live</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: 'class',
    }
    </script>
    
    <!-- ArtPlayer CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.css">
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        #player-container {
            width: 100%;
            height: 100%;
        }
        
        #error-container {
            display: none;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 2rem;
        }
        
        #loading-container {
            display: flex;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: rgb(139, 92, 246);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .error-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .error-message {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
        }
        
        .back-button {
            padding: 0.75rem 2rem;
            background: rgb(139, 92, 246);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .back-button:hover {
            background: rgb(124, 58, 237);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    
    <!-- Loading Container -->
    <div id="loading-container">
        <div class="spinner"></div>
        <p class="mt-4 text-lg">Ê≠£Âú®Âä†ËΩΩËßÜÈ¢ë...</p>
    </div>
    
    <!-- Error Container -->
    <div id="error-container">
        <div class="error-icon">‚ùå</div>
        <div class="error-title" id="error-title">Âä†ËΩΩÂ§±Ë¥•</div>
        <div class="error-message" id="error-message">Êú™Áü•ÈîôËØØ</div>
        <button class="back-button" onclick="goBack()">ËøîÂõûÈ¶ñÈ°µ</button>
    </div>
    
    <!-- Player Container -->
    <div id="player-container"></div>
    
    <script>
        const API_BASE_URL = 'https://neofantasy-api.vercel.app';
        let artPlayer = null;
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò - ‰ªé localStorage ËØªÂèñ
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('bg-gray-900');
                document.body.classList.add('bg-gray-50', 'text-gray-900');
            }
        }
        
        // ‰ªé URL Ëé∑ÂèñÂèÇÊï∞
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                show_id: params.get('show_id'),
                user_token: params.get('user_token')
            };
        }
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(title, message, icon = '‚ùå') {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('player-container').style.display = 'none';
            
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'flex';
            
            document.querySelector('.error-icon').textContent = icon;
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
        }
        
        // ÈöêËóèÂä†ËΩΩÂä®Áîª
        function hideLoading() {
            document.getElementById('loading-container').style.display = 'none';
        }
        
        // ËøîÂõûÈ¶ñÈ°µ
        function goBack() {
            window.close();
            // Â¶ÇÊûú window.close() Â§±Ë¥•ÔºàÈùûËÑöÊú¨ÊâìÂºÄÁöÑÁ™óÂè£ÔºâÔºåÂàôË∑≥ËΩ¨ÂõûÈ¶ñÈ°µ
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 100);
        }
        
        // ÂàùÂßãÂåñÊí≠ÊîæÂô®
        function initPlayer(streamUrl, showId) {
            hideLoading();
            document.getElementById('player-container').style.display = 'block';
            
            artPlayer = new Artplayer({
                container: '#player-container',
                url: streamUrl,
                type: 'm3u8',
                customType: {
                    m3u8: function(video, url) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        }
                    }
                },
                autoplay: true,
                autoSize: false,
                autoMini: false,
                loop: false,
                flip: true,
                playbackRate: true,
                aspectRatio: true,
                setting: true,
                hotkey: true,
                pip: true,
                mutex: true,
                fullscreen: true,
                fullscreenWeb: true,
                subtitle: {
                    url: '',
                },
                moreVideoAttr: {
                    preload: 'auto',
                },
            });

            artPlayer.on('ready', () => {
                console.log('Player is ready');
            });
            
            artPlayer.on('error', (err) => {
                console.error('Player error:', err);
                showError(
                    'Êí≠ÊîæÂ§±Ë¥•',
                    'ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï',
                    '‚ö†Ô∏è'
                );
            });
        }
        
        // Ëé∑ÂèñËßÜÈ¢ëÊµÅÂπ∂Èâ¥ÊùÉ
        async function loadStream() {
            const { show_id, user_token } = getUrlParams();
            
            // ÂèÇÊï∞Ê†°È™å
            if (!show_id || !user_token) {
                showError(
                    'ÂèÇÊï∞ÈîôËØØ',
                    'Áº∫Â∞ëÂøÖË¶ÅÁöÑÂèÇÊï∞ÔºåËØ∑‰ªéÈ¶ñÈ°µÈáçÊñ∞ËøõÂÖ•',
                    '‚ö†Ô∏è'
                );
                return;
            }
            
            try {
                console.log('Requesting stream for show:', show_id);
                const response = await fetch(`${API_BASE_URL}/get-stream?show_id=${show_id}&user_token=${user_token}`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Stream URL received:', data.url);
                    initPlayer(data.url, show_id);
                } else {
                    // Ê†πÊçÆ‰∏çÂêåÁöÑÈîôËØØÁ†ÅÊòæÁ§∫‰∏çÂêåÁöÑÈîôËØØ‰ø°ÊÅØ
                    let errorTitle = 'Âä†ËΩΩÂ§±Ë¥•';
                    let errorMessage = 'Êú™Áü•ÈîôËØØ';
                    let errorIcon = '‚ùå';
                    
                    switch (response.status) {
                        case 403:
                            errorTitle = 'ÊùÉÈôê‰∏çË∂≥';
                            errorMessage = 'ÊÇ®Â∞öÊú™Ë¥≠‰π∞Ê≠§ËäÇÁõÆÔºåÊàñÊÇ®ÁöÑËÆøÈóÆ‰ª§ÁâåÂ∑≤ËøáÊúü';
                            errorIcon = 'üîí';
                            break;
                        case 404:
                            errorTitle = 'ËßÜÈ¢ëÊú™ÊâæÂà∞';
                            errorMessage = 'ËØ•ËßÜÈ¢ëÊöÇÊú™‰∏äÁ∫øÊàñÂ∑≤‰∏ãÊû∂ÔºåËØ∑Á®çÂêéÈáçËØï';
                            errorIcon = 'üîç';
                            break;
                        case 400:
                            errorTitle = 'ÂèÇÊï∞ÈîôËØØ';
                            errorMessage = 'ËØ∑Ê±ÇÂèÇÊï∞ÊúâËØØÔºåËØ∑ËøîÂõûÈ¶ñÈ°µÈáçÊñ∞ËøõÂÖ•';
                            errorIcon = '‚ö†Ô∏è';
                            break;
                        case 500:
                        case 502:
                        case 503:
                            errorTitle = 'ÊúçÂä°Âô®ÈîôËØØ';
                            errorMessage = 'ÊúçÂä°Âô®ÊöÇÊó∂Êó†Ê≥ïÂìçÂ∫îÔºåËØ∑Á®çÂêéÈáçËØï';
                            errorIcon = 'üîß';
                            break;
                        default:
                            errorTitle = 'Âä†ËΩΩÂ§±Ë¥•';
                            errorMessage = `ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÈîôËØØÁ†Å: ${response.status}`;
                            errorIcon = '‚ùå';
                    }
                    
                    showError(errorTitle, errorMessage, errorIcon);
                }
            } catch (error) {
                console.error('Network error:', error);
                showError(
                    'ÁΩëÁªúÈîôËØØ',
                    'Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•',
                    'üåê'
                );
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadStream();
        });
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            if (!artPlayer) return;
            
            if (e.code === 'Space') {
                e.preventDefault();
                artPlayer.toggle();
            } else if (e.code === 'ArrowLeft') {
                e.preventDefault();
                artPlayer.currentTime = Math.max(0, artPlayer.currentTime - 5);
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                artPlayer.currentTime = artPlayer.currentTime + 5;
            } else if (e.code === 'ArrowUp') {
                e.preventDefault();
                artPlayer.volume = Math.min(1, artPlayer.volume + 0.1);
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                artPlayer.volume = Math.max(0, artPlayer.volume - 0.1);
            } else if (e.code === 'KeyF') {
                e.preventDefault();
                artPlayer.fullscreen = !artPlayer.fullscreen;
            } else if (e.code === 'Escape' && artPlayer.fullscreen) {
                e.preventDefault();
                artPlayer.fullscreen = false;
            }
        });
        
        // È°µÈù¢ÂÖ≥Èó≠ÂâçÊ∏ÖÁêÜ
        window.addEventListener('beforeunload', () => {
            if (artPlayer) {
                artPlayer.destroy();
            }
        });
    </script>
</body>
</html>
