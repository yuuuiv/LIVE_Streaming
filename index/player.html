<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’­æ”¾å™¨ - NeoFantasy Live</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: 'class',
    }
    </script>
    
    <!-- ArtPlayer CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.css">
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        #player-container {
            width: 100%;
            height: 100%;
        }
        
        #error-container {
            display: none;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 2rem;
        }
        
        #loading-container {
            display: flex;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: rgb(139, 92, 246);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .error-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .error-message {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
        }
        
        .back-button {
            padding: 0.75rem 2rem;
            background: rgb(139, 92, 246);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .back-button:hover {
            background: rgb(124, 58, 237);
        }

        .back-button-red {
            background: #ef4444 !important;
        }
        .back-button-red:hover {
            background: #dc2626 !important;
        }

        /* è¢«è¸¢ä¸‹çº¿é®ç½© */
        #kick-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            color: #f87171;
            z-index: 50;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding: 2rem;
        }
        #kick-overlay h2 {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
        }
        #kick-overlay p {
            color: #fecaca;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    
    <!-- Loading Container -->
    <div id="loading-container">
        <div class="spinner"></div>
        <p class="mt-4 text-lg">æ­£åœ¨åŠ è½½è§†é¢‘...</p>
    </div>
    
    <!-- Error Container -->
    <div id="error-container">
        <div class="error-icon">âŒ</div>
        <div class="error-title" id="error-title">åŠ è½½å¤±è´¥</div>
        <div class="error-message" id="error-message">æœªçŸ¥é”™è¯¯</div>
        <button class="back-button" onclick="goBack()">è¿”å›é¦–é¡µ</button>
    </div>
    
    <!-- Player Container -->
    <div id="player-container"></div>

    <!-- Kick Overlay -->
    <div id="kick-overlay">
        <h2>âš  æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•</h2>
        <p>å½“å‰æ’­æ”¾å·²åœæ­¢ï¼Œè¯·é‡æ–°ç™»å½•åç»§ç»­è§‚çœ‹ã€‚</p>
        <button class="back-button back-button-red" type="button" onclick="goBack()">è¿”å›é¦–é¡µ</button>
    </div>
    
    <script>
        const API_BASE_URL = 'https://api.neofantasy.online';
        let artPlayer = null;
        let heartbeatTimer = null;
        let sessionId = null;
        let username = null;
        
        // åˆå§‹åŒ–ä¸»é¢˜ - ä» localStorage è¯»å–
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('bg-gray-900');
                document.body.classList.add('bg-gray-50', 'text-gray-900');
            }
        }
        
        // ä» URL è·å–å‚æ•°
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                show_id: params.get('show_id'),
                user_token: params.get('user_token')
            };
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(title, message, icon = 'âŒ') {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('player-container').style.display = 'none';
            
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'flex';
            
            document.querySelector('.error-icon').textContent = icon;
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
        }
        
        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            document.getElementById('loading-container').style.display = 'none';
        }
        
        // è¿”å›é¦–é¡µ
        function goBack() {
            window.close();
            // å¦‚æœ window.close() å¤±è´¥ï¼ˆéè„šæœ¬æ‰“å¼€çš„çª—å£ï¼‰ï¼Œåˆ™è·³è½¬å›é¦–é¡µ
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 100);
        }
        
        // åˆå§‹åŒ–æ’­æ”¾å™¨
        function initPlayer(streamUrl, showId) {
            hideLoading();
            document.getElementById('player-container').style.display = 'block';
            
            artPlayer = new Artplayer({
                container: '#player-container',
                url: streamUrl,
                type: 'm3u8',
                customType: {
                    m3u8: function(video, url) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        }
                    }
                },
                autoplay: true,
                autoSize: false,
                autoMini: false,
                loop: false,
                flip: true,
                playbackRate: true,
                aspectRatio: true,
                setting: true,
                hotkey: true,
                pip: true,
                mutex: true,
                fullscreen: true,
                fullscreenWeb: true,
                subtitle: {
                    url: '',
                },
                moreVideoAttr: {
                    preload: 'auto',
                },
            });

            artPlayer.on('ready', () => {
                console.log('Player is ready');
            });
            
            artPlayer.on('error', (err) => {
                console.error('Player error:', err);
                showError(
                    'æ’­æ”¾å¤±è´¥',
                    'è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•',
                    'âš ï¸'
                );
            });
        }

        function handleKicked(message = 'æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚') {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
            }
            if (artPlayer) {
                artPlayer.destroy();
                artPlayer = null;
            }
            document.getElementById('kick-overlay').style.display = 'flex';
            document.querySelector('#kick-overlay p').textContent = message;
        }

        async function startHeartbeat() {
            if (!username || !sessionId) return;
            heartbeatTimer = setInterval(async () => {
                try {
                    const resp = await fetch(`${API_BASE_URL}/api/heartbeat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, session_id: sessionId })
                    });

                    if (resp.status === 403) {
                        handleKicked('æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚');
                        return;
                    }

                    if (!resp.ok) {
                        handleKicked('æ ¡éªŒå¤±è´¥ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚');
                        return;
                    }
                } catch (err) {
                    console.error('heartbeat error:', err);
                    handleKicked('é‰´æƒå¼‚å¸¸ï¼Œå½“å‰æ’­æ”¾å·²åœæ­¢ã€‚');
                }
            }, 25000); // 25s
        }
        
        // è·å–è§†é¢‘æµå¹¶é‰´æƒ
        async function loadStream() {
            const { show_id, user_token } = getUrlParams();
            username = user_token;
            
            // å‚æ•°æ ¡éªŒ
            if (!show_id || !user_token) {
                showError(
                    'å‚æ•°é”™è¯¯',
                    'ç¼ºå°‘å¿…è¦çš„å‚æ•°ï¼Œè¯·ä»é¦–é¡µé‡æ–°è¿›å…¥',
                    'âš ï¸'
                );
                return;
            }
            
            try {
                console.log('Requesting stream for show:', show_id);
                const response = await fetch(`${API_BASE_URL}/get-stream?show_id=${show_id}&user_token=${user_token}`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Stream URL received:', data.url);
                    sessionId = data.session_id;
                    if (!sessionId) {
                        showError('ä¼šè¯åˆ›å»ºå¤±è´¥', 'æœåŠ¡å™¨æœªè¿”å›ä¼šè¯ä¿¡æ¯ï¼Œè¯·é‡è¯•', 'âš ï¸');
                        return;
                    }
                    initPlayer(data.url, show_id);
                    startHeartbeat();
                } else {
                    // æ ¹æ®ä¸åŒçš„é”™è¯¯ç æ˜¾ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯
                    let errorTitle = 'åŠ è½½å¤±è´¥';
                    let errorMessage = 'æœªçŸ¥é”™è¯¯';
                    let errorIcon = 'âŒ';
                    
                    switch (response.status) {
                        case 403:
                            errorTitle = 'æƒé™ä¸è¶³';
                            errorMessage = 'æ‚¨å°šæœªè´­ä¹°æ­¤èŠ‚ç›®ï¼Œæˆ–æ‚¨çš„è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ';
                            errorIcon = 'ğŸ”’';
                            break;
                        case 404:
                            errorTitle = 'è§†é¢‘æœªæ‰¾åˆ°';
                            errorMessage = 'è¯¥è§†é¢‘æš‚æœªä¸Šçº¿æˆ–å·²ä¸‹æ¶ï¼Œè¯·ç¨åé‡è¯•';
                            errorIcon = 'ğŸ”';
                            break;
                        case 400:
                            errorTitle = 'å‚æ•°é”™è¯¯';
                            errorMessage = 'è¯·æ±‚å‚æ•°æœ‰è¯¯ï¼Œè¯·è¿”å›é¦–é¡µé‡æ–°è¿›å…¥';
                            errorIcon = 'âš ï¸';
                            break;
                        case 500:
                        case 502:
                        case 503:
                            errorTitle = 'æœåŠ¡å™¨é”™è¯¯';
                            errorMessage = 'æœåŠ¡å™¨æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åé‡è¯•';
                            errorIcon = 'ğŸ”§';
                            break;
                        default:
                            errorTitle = 'åŠ è½½å¤±è´¥';
                            errorMessage = `è¯·æ±‚å¤±è´¥ï¼Œé”™è¯¯ç : ${response.status}`;
                            errorIcon = 'âŒ';
                    }
                    
                    showError(errorTitle, errorMessage, errorIcon);
                }
            } catch (error) {
                console.error('Network error:', error);
                showError(
                    'ç½‘ç»œé”™è¯¯',
                    'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥',
                    'ğŸŒ'
                );
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadStream();
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (!artPlayer) return;
            
            if (e.code === 'Space') {
                e.preventDefault();
                artPlayer.toggle();
            } else if (e.code === 'ArrowLeft') {
                e.preventDefault();
                artPlayer.currentTime = Math.max(0, artPlayer.currentTime - 5);
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                artPlayer.currentTime = artPlayer.currentTime + 5;
            } else if (e.code === 'ArrowUp') {
                e.preventDefault();
                artPlayer.volume = Math.min(1, artPlayer.volume + 0.1);
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                artPlayer.volume = Math.max(0, artPlayer.volume - 0.1);
            } else if (e.code === 'KeyF') {
                e.preventDefault();
                artPlayer.fullscreen = !artPlayer.fullscreen;
            } else if (e.code === 'Escape' && artPlayer.fullscreen) {
                e.preventDefault();
                artPlayer.fullscreen = false;
            }
        });
        
        // é¡µé¢å…³é—­å‰æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
            }
            if (artPlayer) {
                artPlayer.destroy();
            }
        });
    </script>
</body>
</html>
