<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoFantasy Live</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: 'class', // å…è®¸é€šè¿‡ç»™ <html> æ ‡ç­¾æ·»åŠ  'dark' ç±»æ¥åˆ‡æ¢æ¨¡å¼
    }
    </script>
    
    <!-- ArtPlayer CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.css">
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        /* å¢åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
        html, body { transition: background-color 0.3s, color 0.3s; }        
        .show-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .show-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }
        .badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        #player-container {
            display: none;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-white min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg dark:bg-gray-800">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-purple-600 dark:text-purple-400">NeoFantasy Live</h1>
                    <span class="text-sm text-gray-500 dark:text-gray-400">live.neofantasy.online</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="toggleTheme()" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                        <span id="theme-icon">ğŸŒ™</span>
                    </button>
                    
                    <div id="user-status" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm">èº«ä»½: </span>
                        <span id="user-role" class="font-semibold text-yellow-600 dark:text-yellow-400">æœªç™»å½•</span>
                    </div>
                    
                    <div id="auth-buttons" class="flex space-x-2">
                        <button onclick="showLoginModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                            ç™»å½•
                        </button>
                        <button onclick="showRegisterModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
                            æ³¨å†Œ
                        </button>
                    </div>
                    
                    <div id="user-menu" class="hidden">
                        <button onclick="toggleUserDashboard()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition">
                            æˆ‘çš„è®¢é˜…
                        </button>
                        <button onclick="logout()" class="px-4 py-2 ml-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
                            ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Player Section (Hidden by default) -->
        <div id="player-section" class="mb-8 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="now-playing-title" class="text-xl font-bold">æ­£åœ¨æ’­æ”¾...</h2>
                    <button onclick="closePlayer()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
                        å…³é—­æ’­æ”¾å™¨
                    </button>
                </div>
                <div id="player-container" class="w-full"></div>
            </div>
        </div>

        <!-- Shows Grid -->
        <div id="shows-section">
            <h2 class="text-2xl font-bold mb-6">ğŸ¬ æ’­æ”¾åˆ—è¡¨</h2>
            <div id="shows-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Shows will be dynamically loaded here -->
            </div>
        </div>

        <!-- User Dashboard (Hidden by default) -->
        <div id="user-dashboard" class="mt-8 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">ğŸ“¦ æˆ‘çš„è®¢é˜…</h2>
                    <button onclick="toggleUserDashboard()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white">
                        âœ• å…³é—­
                    </button>
                </div>
                <div id="purchased-shows" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Purchased shows will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-center">ğŸ” ç”¨æˆ·ç™»å½•</h3>
            
            <form id="login-form" onsubmit="event.preventDefault(); login();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">ç”¨æˆ·å</label>
                        <input type="text" id="login-username" required
                               class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">å¯†ç </label>
                        <input type="password" id="login-password" required
                               class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div id="login-error" class="text-red-500 text-sm hidden"></div>
                    
                    <div class="space-y-3">
                        <button type="submit" 
                                class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition">
                            ç™»å½•
                        </button>
                        <button type="button" onclick="hideLoginModal()"
                                class="w-full px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                            å–æ¶ˆ
                        </button>
                        <div class="text-center text-sm text-gray-500">
                            è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="javascript:void(0)" onclick="switchToRegister()" class="text-blue-500 hover:underline">ç«‹å³æ³¨å†Œ</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-center">ğŸ“ ç”¨æˆ·æ³¨å†Œ</h3>
            
            <form id="register-form" onsubmit="event.preventDefault(); register();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">ç”¨æˆ·å</label>
                        <input type="text" id="register-username" required
                               class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">å¯†ç </label>
                        <input type="password" id="register-password" required
                               class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="register-confirm-password" required
                               class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div id="register-error" class="text-red-500 text-sm hidden"></div>
                    <div id="register-success" class="text-green-500 text-sm hidden"></div>
                    
                    <div class="space-y-3">
                        <button type="submit" 
                                class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition">
                            æ³¨å†Œ
                        </button>
                        <button type="button" onclick="hideRegisterModal()"
                                class="w-full px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                            å–æ¶ˆ
                        </button>
                        <div class="text-center text-sm text-gray-500">
                            å·²æœ‰è´¦å·ï¼Ÿ <a href="javascript:void(0)" onclick="switchToLogin()" class="text-blue-500 hover:underline">ç«‹å³ç™»å½•</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://neofantasy-api.vercel.app'; // ä¿®æ”¹ä¸ºåç«¯æœåŠ¡å™¨åœ°å€
        const TOKEN_KEY = 'user_token';
        const PURCHASED_SHOWS_KEY = 'purchased_shows';
        const USERNAME_KEY = 'username';
        
        // Global variables
        let artPlayer = null;
        let currentShowId = null;
        let purchasedShows = [];
        
        // shows data
        const Shows = [
            { id: 'test', title: "test", description: 'æµ‹è¯•ç”¨', thumbnail: 'https://via.placeholder.com/400x300/8B5CF6/ffffff?text=Music+Show', isLive: false, requiresAuth: true },

            { id: 'ppp_0103', title: "Poppin'Party New Year LIVEã€ŒHappy BanG Year!!ã€", description: '2026å¹´1æœˆ3æ—¥(åœŸ) é–‹æ¼” 18:00(JST)', thumbnail: 'https://via.placeholder.com/400x300/8B5CF6/ffffff?text=Music+Show', isLive: false, requiresAuth: true },

        ];

        // --- ä¸»é¢˜åˆ‡æ¢é€»è¾‘ ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').textContent = 'ğŸŒ™';
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            document.getElementById('theme-icon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); // åˆå§‹åŒ–ä¸»é¢˜
            updateAuthUI(); // åˆå§‹åŒ–è®¤è¯çŠ¶æ€æ˜¾ç¤º
            loadShows();
        });

        // æ›´æ–°è®¤è¯UIçŠ¶æ€ - æ ¹æ®localStorageè¯»å–tokenæ˜¾ç¤ºå¯¹åº”UI
        function updateAuthUI() {
            const token = localStorage.getItem(TOKEN_KEY);
            const username = localStorage.getItem(USERNAME_KEY);
            
            if (token && username) {
                // ç”¨æˆ·å·²ç™»å½•ï¼šéšè—ç™»å½•/æ³¨å†ŒæŒ‰é’®ï¼Œæ˜¾ç¤ºç”¨æˆ·èœå•
                document.getElementById('auth-buttons').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-role').textContent = username;
                document.getElementById('user-role').classList.remove('text-yellow-600', 'dark:text-yellow-400');
                document.getElementById('user-role').classList.add('text-purple-600', 'dark:text-purple-400');
                
                // åŠ è½½å·²è´­èŠ‚ç›®åˆ—è¡¨
                updatePurchasedShows();
            } else {
                // ç”¨æˆ·æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•/æ³¨å†ŒæŒ‰é’®ï¼Œéšè—ç”¨æˆ·èœå•
                document.getElementById('auth-buttons').classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
                document.getElementById('user-role').textContent = 'æœªç™»å½•';
                document.getElementById('user-role').classList.remove('text-purple-600', 'dark:text-purple-400');
                document.getElementById('user-role').classList.add('text-yellow-600', 'dark:text-yellow-400');
            }
        }

        // Load shows into grid
        function loadShows() {
            const grid = document.getElementById('shows-grid');
            grid.innerHTML = '';
            
            Shows.forEach(show => {
                grid.appendChild(createShowCard(show));
            });
        }

        // Create show card element - ä¿®å¤äº‹ä»¶å†’æ³¡é—®é¢˜
        function createShowCard(show) {
            const card = document.createElement('div');
            card.className = 'show-card bg-white dark:bg-gray-800 rounded-lg overflow-hidden relative shadow-md';
            
            const imagePath = `/image/${show.title}.jpg`;
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${imagePath}" alt="${show.title}" class="w-full h-48 object-cover">
                    ${show.isLive ? '<span class="badge bg-red-600 text-white animate-pulse">â— ç›´æ’­ä¸­</span>' : '<span class="badge bg-gray-500 text-white">å¾…å¼€æ’­</span>'}
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-bold mb-2">${show.title}</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-3">${show.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-sm ${show.requiresAuth ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400'}">
                            ${show.requiresAuth ? 'ğŸ”’ éœ€è¦ç™»å½•' : 'ğŸ†“ å…è´¹è§‚çœ‹'}
                        </span>
                        <button class="watch-btn px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-white transition" data-show-id="${show.id}">
                            è§‚çœ‹
                        </button>
                    </div>
                </div>
            `;
            
            // ä¸ºè§‚çœ‹æŒ‰é’®å•ç‹¬æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const watchBtn = card.querySelector('.watch-btn');
            watchBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                handleShowClick(this.getAttribute('data-show-id'));
            });
            
            // å¡ç‰‡å…¶ä»–åŒºåŸŸç‚¹å‡»ä¹Ÿè§¦å‘è§‚çœ‹
            card.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®ï¼Œåˆ™è§¦å‘è§‚çœ‹
                if (!e.target.closest('.watch-btn')) {
                    handleShowClick(show.id);
                }
            });
            
            return card;
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (!artPlayer) return; // åªåœ¨æ’­æ”¾å™¨å­˜åœ¨æ—¶å“åº”å¿«æ·é”®
            
            if (e.code === 'Space') {
                e.preventDefault();
                artPlayer.toggle();
            } else if (e.code === 'ArrowLeft') {
                e.preventDefault();
                artPlayer.currentTime = Math.max(0, artPlayer.currentTime - 5);
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                artPlayer.currentTime = artPlayer.currentTime + 5;
            } else if (e.code === 'ArrowUp') {
                e.preventDefault();
                artPlayer.volume = Math.min(1, artPlayer.volume + 0.1);
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                artPlayer.volume = Math.max(0, artPlayer.volume - 0.1);
            } else if (e.code === 'KeyF' || e.code === 'Enter') {
                e.preventDefault();
                artPlayer.fullscreen = !artPlayer.fullscreen;
            }
        });

        // Handle show click - åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ’­æ”¾å™¨
        function handleShowClick(showId) {
            currentShowId = showId;
            const token = localStorage.getItem(TOKEN_KEY);
            
            // Check if user is logged in
            if (!token) {
                showLoginModal();
                return;
            }
            
            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ’­æ”¾å™¨é¡µé¢ï¼Œä¼ é€’ show_id å’Œ user_token
            const playerUrl = `player.html?show_id=${encodeURIComponent(showId)}&user_token=${encodeURIComponent(token)}`;
            window.open(playerUrl, '_blank');
        }

        // Play stream with ArtPlayer
        function playStream(url, showId) {
            document.getElementById('player-section').classList.remove('hidden');
            const show = Shows.find(s => s.id === showId);
            const showTitle = show ? show.title : 'èŠ‚ç›®';
            document.getElementById('now-playing-title').textContent = `æ­£åœ¨æ’­æ”¾: ${showTitle}`;
            document.getElementById('player-container').style.display = 'block';
            
            // Scroll to player
            document.getElementById('player-section').scrollIntoView({ behavior: 'smooth' });
            
            // Destroy existing player if any
            if (artPlayer) {
                artPlayer.destroy();
            }
            
            // Initialize ArtPlayer
            artPlayer = new Artplayer({
                container: '#player-container',
                url: url,
                type: 'm3u8',
                customType: {
                    m3u8: function(video, url) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        }
                    }
                },
                autoplay: true,
                autoSize: true,
                autoMini: true,
                loop: false,
                flip: true,
                playbackRate: true,
                aspectRatio: true,
                setting: true,
                hotkey: true,
                pip: true,
                mutex: true,
                fullscreen: true,
                fullscreenWeb: true,
                subtitle: {
                    url: '',
                },
                moreVideoAttr: {
                    preload: 'auto',
                },
            });

            artPlayer.on('ready', () => {
                console.log('Player is ready');
            });
            
            artPlayer.on('error', (err) => {
                console.error('Player error:', err);
                alert('æ’­æ”¾å™¨é”™è¯¯: ' + err.message);
            });
        }

        // Close player
        function closePlayer() {
            if (artPlayer) {
                artPlayer.destroy();
                artPlayer = null;
            }
            document.getElementById('player-section').classList.add('hidden');
            document.getElementById('player-container').style.display = 'none';
        }

        // Login function - ç™»å½•å‡½æ•°ï¼ŒæˆåŠŸåæŒä¹…åŒ–tokenå’Œusername
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            
            if (!username || !password) {
                loginError.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
                loginError.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }) // å¿…é¡»å¯¹åº”åç«¯çš„ req.body.username
                });

                const data = await response.json();
                if (response.ok) {
                    // æˆåŠŸç™»å½•ï¼Œä¿å­˜tokenå’Œusernameåˆ°localStorage
                    localStorage.setItem(TOKEN_KEY, data.token);
                    localStorage.setItem(USERNAME_KEY, username); // å…³é”®ï¼šä¿å­˜ç”¨æˆ·åä»¥å®ç°æŒä¹…åŒ–
                    // ä¿å­˜åç«¯è¿”å›çš„çœŸå®å·²è´­åˆ—è¡¨
                    localStorage.setItem(PURCHASED_SHOWS_KEY, JSON.stringify(data.purchased_shows || []));
                    
                    // æ›´æ–°UIè€Œä¸æ˜¯åˆ·æ–°é¡µé¢ï¼ˆå¯é€‰ï¼šåˆ·æ–°æ›´ç¨³å¦¥ï¼‰
                    hideLoginModal();
                    updateAuthUI();
                    alert('ç™»å½•æˆåŠŸï¼');
                    // å¦‚æœè¦åˆ·æ–°é¡µé¢ï¼šlocation.reload();
                } else {
                    loginError.textContent = data.error || 'ç™»å½•å¤±è´¥';
                    loginError.classList.remove('hidden');
                }
            } catch (e) {
                loginError.textContent = 'æ— æ³•è¿æ¥åˆ°éªŒè¯æœåŠ¡å™¨';
                loginError.classList.remove('hidden');
            }
        }

        // Register function
        async function register() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-error');
            const successElement = document.getElementById('register-success');
            
            errorElement.classList.add('hidden');
            successElement.classList.add('hidden');
            
            // Validation
            if (!username || !password) {
                errorElement.textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorElement.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = 'å¯†ç é•¿åº¦è‡³å°‘6ä½';
                errorElement.classList.remove('hidden');
                return;
            }
            
            try {
                console.log('Attempting registration for user:', username);
                const response = await fetch(`${API_BASE_URL}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                console.log('Register response status:', response.status);
                const data = await response.json();
                console.log('Register response data:', data);
                
                if (response.status === 201) {
                    // Registration successful
                    successElement.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•';
                    successElement.classList.remove('hidden');
                    
                    // Clear form
                    document.getElementById('register-username').value = '';
                    document.getElementById('register-password').value = '';
                    document.getElementById('register-confirm-password').value = '';
                    
                    // Auto switch to login after 2 seconds
                    setTimeout(() => {
                        hideRegisterModal();
                        showLoginModal();
                        document.getElementById('login-username').value = username;
                    }, 2000);
                } else {
                    errorElement.textContent = data.error || 'æ³¨å†Œå¤±è´¥';
                    errorElement.classList.remove('hidden');
                }
            } catch (e) {
                console.error('Register error:', e);
                errorElement.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                errorElement.classList.remove('hidden');
            }
        }

        // Logout function - ç™»å‡ºå‡½æ•°ï¼Œæ¸…é™¤æ‰€æœ‰localStorageæ•°æ®å¹¶æ›´æ–°UI
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                // æ¸…é™¤æ‰€æœ‰è®¤è¯ç›¸å…³çš„localStorageæ•°æ®
                localStorage.removeItem(TOKEN_KEY);
                localStorage.removeItem(USERNAME_KEY);
                localStorage.removeItem(PURCHASED_SHOWS_KEY);
                
                // å…³é—­æ’­æ”¾å™¨
                closePlayer();
                
                // æ›´æ–°UIæ˜¾ç¤ºä¸ºæœªç™»å½•çŠ¶æ€
                updateAuthUI();
                
                // æ›´æ–°ç”¨æˆ·ä»ªè¡¨æ¿
                updateUserDashboard();
                
                // æç¤ºç”¨æˆ·
                alert('å·²é€€å‡ºç™»å½•');
            }
        }

        // Update purchased shows from localStorage
        function updatePurchasedShows() {
            const stored = localStorage.getItem(PURCHASED_SHOWS_KEY);
            purchasedShows = stored ? JSON.parse(stored) : [];
        }

        // Get purchased shows
        function getPurchasedShows() {
            return purchasedShows;
        }

        // Modal functions
        function showLoginModal() {
            document.getElementById('login-modal').classList.add('active');
        }
        
        function hideLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        }
        
        function showRegisterModal() {
            document.getElementById('register-modal').classList.add('active');
        }
        
        function hideRegisterModal() {
            document.getElementById('register-modal').classList.remove('active');
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm-password').value = '';
        }
        
        function switchToRegister() {
            hideLoginModal();
            showRegisterModal();
        }
        
        function switchToLogin() {
            hideRegisterModal();
            showLoginModal();
        }

        // Toggle user dashboard
        function toggleUserDashboard() {
            const dashboard = document.getElementById('user-dashboard');
            dashboard.classList.toggle('hidden');
            if (!dashboard.classList.contains('hidden')) {
                updateUserDashboard();
                dashboard.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Update user dashboard
        function updateUserDashboard() {
            const purchasedShows = getPurchasedShows();
            const container = document.getElementById('purchased-shows');
            
            if (purchasedShows.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-8">æ‚¨è¿˜æ²¡æœ‰è´­ä¹°ä»»ä½•èŠ‚ç›®</p>';
                return;
            }
            
            container.innerHTML = '';
            purchasedShows.forEach(showId => {
                const show = Shows.find(s => s.id === showId);
                if (show) {
                    const card = document.createElement('div');
                    
                    card.className = 'bg-gray-100 dark:bg-gray-700 rounded-lg p-4 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition shadow-sm';
                    card.onclick = () => {
                        toggleUserDashboard();
                        handleShowClick(showId);
                    };
                    
                    card.innerHTML = `
                        <h4 class="font-bold mb-2">${show.title}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-300 mb-2">${show.description}</p>
                        <span class="text-xs text-green-600 dark:text-green-400 font-medium">âœ“ å·²è´­ä¹°</span>
                    `;
                    container.appendChild(card);
                }
            });
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            const loginModal = document.getElementById('login-modal');
            const registerModal = document.getElementById('register-modal');
            
            if (loginModal.classList.contains('active') && e.target === loginModal) {
                hideLoginModal();
            }
            
            if (registerModal.classList.contains('active') && e.target === registerModal) {
                hideRegisterModal();
            }
        });
    </script>
    <footer class="mt-12 py-8 border-t border-gray-200 dark:border-gray-800 transition-colors">
        <div class="container mx-auto px-4 text-center">
            <div class="flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-4 text-xs text-gray-400 dark:text-gray-500">
                <p>Â©2025 NeoFantasy Online. All rights reserved.</p>
                <span class="hidden md:inline">|</span>
                <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener" class="hover:text-purple-500 transition-colors">
                    æ²ªICPå¤‡2024092905å·
                </a>
            </div>
        </div>
    </footer>
</body>
</html>